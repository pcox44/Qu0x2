<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daily Dice Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
  }

  #dice-container {
    display: flex;
    gap: 10px;
    margin: 10px 0;
  }

  .die {
    width: 50px;
    height: 50px;
    border-radius: 6px;
    color: black;
    font-weight: bold;
    font-size: 24px;
    line-height: 50px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    border: 2px solid black;
  }

  .die.used {
    opacity: 0.3;
    cursor: default;
  }

  #expression-container {
    min-height: 30px;
    font-size: 20px;
    margin-bottom: 10px;
    border: 1px solid #888;
    padding: 6px;
    border-radius: 4px;
    min-width: 200px;
  }

  #buttons-container button {
    margin: 4px;
    padding: 8px 12px;
    font-size: 18px;
    cursor: pointer;
  }

  #target-container {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
  }

  #result, #score, #streak, #archive {
    margin-top: 15px;
  }
</style>
</head>
<body>
  <h1>Daily Dice Game</h1>
  <div id="target-container">
    Target Number: <span id="target-number"></span>
  </div>

  <div id="dice-container"></div>

  <div id="expression-container">
    <div id="expr-text" class="expression"></div>
  </div>

  <div id="buttons-container">
    <button id="btn-add">+</button>
    <button id="btn-sub">-</button>
    <button id="btn-mul">&times;</button>
    <button id="btn-div">&divide;</button>
    <button id="btn-backspace">Backspace</button>
    <button id="btn-clear">Clear</button>
    <button id="btn-submit">Submit</button>
  </div>

  <div id="result"></div>
  <div id="score"></div>
  <div id="streak"></div>
  <div id="archive"></div>

<script>
  // --- Helpers ---
  function getEasternMidnight() {
    const now = new Date();
    const utc = now.getTime() + now.getTimezoneOffset() * 60000;
    const estOffset = -4 * 60; // EDT offset in minutes
    const estTime = new Date(utc + estOffset * 60000);
    estTime.setHours(0, 0, 0, 0);
    return estTime;
  }

  function seedFromDate() {
    const estMidnight = getEasternMidnight();
    return estMidnight.getFullYear() * 10000 + (estMidnight.getMonth() + 1) * 100 + estMidnight.getDate();
  }

  function seededRandom(seed) {
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }

  function shuffleArray(array, seed) {
    let random = () => seededRandom(seed++);
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // --- Variables ---
  let targetNumber;
  let diceValues = [];
  let usedDice = [false, false, false, false, false];
  let expression = "";
  const diceColors = ["#e63946", "#f1faee", "#a8dadc", "#457b9d", "#1d3557"];

  const diceContainer = document.getElementById("dice-container");
  const targetSpan = document.getElementById("target-number");
  const exprText = document.getElementById("expr-text");
  const resultDiv = document.getElementById("result");
  const scoreDiv = document.getElementById("score");
  const streakDiv = document.getElementById("streak");
  const archiveDiv = document.getElementById("archive");

  // --- Game Setup ---
  function initGame() {
    expression = "";
    usedDice = [false, false, false, false, false];
    updateExpression();

    const seed = seedFromDate();

    targetNumber = Math.floor(seededRandom(seed) * 100) + 1;
    targetSpan.textContent = targetNumber;

    diceValues = [1, 2, 3, 4, 5, 6];
    shuffleArray(diceValues, seed + 100);
    diceValues = diceValues.slice(0, 5);

    diceContainer.innerHTML = "";
    diceValues.forEach((value, i) => {
      const die = document.createElement("div");
      die.classList.add("die");
      die.textContent = value;
      die.style.backgroundColor = diceColors[i % diceColors.length];
      die.dataset.index = i;
      die.addEventListener("click", () => toggleDieUsage(i));
      diceContainer.appendChild(die);
    });

    loadProgress();
    updateScore("");
    updateStreak();
    updateArchive();

    // Attach button event listeners
    document.getElementById("btn-add").addEventListener("click", () => appendOperator("+"));
    document.getElementById("btn-sub").addEventListener("click", () => appendOperator("-"));
    document.getElementById("btn-mul").addEventListener("click", () => appendOperator("*"));
    document.getElementById("btn-div").addEventListener("click", () => appendOperator("/"));
    document.getElementById("btn-backspace").addEventListener("click", backspace);
    document.getElementById("btn-clear").addEventListener("click", clearExpression);
    document.getElementById("btn-submit").addEventListener("click", checkAnswer);
  }

  function toggleDieUsage(i) {
    if (usedDice[i]) return; // already used
    appendNumber(diceValues[i]);
    usedDice[i] = true;
    updateDiceStyles();
  }

  function updateDiceStyles() {
    diceContainer.childNodes.forEach((die, i) => {
      if (usedDice[i]) die.classList.add("used");
      else die.classList.remove("used");
    });
  }

  function appendNumber(num) {
    expression += num.toString();
    updateExpression();
  }

  function appendOperator(op) {
    if (expression.length === 0) return; // prevent operator first
    const lastChar = expression[expression.length - 1];
    if ("+-*/".includes(lastChar)) return; // prevent double operators
    expression += op;
    updateExpression();
  }

  function backspace() {
    if (expression.length === 0) return;
    const lastChar = expression.slice(-1);
    expression = expression.slice(0, -1);
    if (/\d/.test(lastChar)) {
      for (let i = diceValues.length - 1; i >= 0; i--) {
        if (usedDice[i] && diceValues[i].toString() === lastChar) {
          usedDice[i] = false;
          break;
        }
      }
    }
    updateDiceStyles();
    updateExpression();
    updateScore("");
  }

  function clearExpression() {
    expression = "";
    usedDice = [false, false, false, false, false];
    updateDiceStyles();
    updateExpression();
    updateScore("");
  }

  function updateExpression() {
    exprText.textContent = expression;
  }

  function checkAnswer() {
    if (expression.length === 0) {
      resultDiv.textContent = "Enter an expression!";
      return;
    }
    if (usedDice.includes(false)) {
      resultDiv.textContent = "You must use all dice exactly once.";
      return;
    }
    if (!/^[0-9+\-*/() ]+$/.test(expression)) {
      resultDiv.textContent = "Invalid characters in expression.";
      return;
    }
    try {
      // Evaluate expression safely
      const val = eval(expression);
      if (typeof val !== "number" || isNaN(val) || !isFinite(val)) {
        resultDiv.textContent = "Expression result invalid.";
        return;
      }

      const diff = Math.abs(val - targetNumber);
      resultDiv.textContent = `Result: ${val} (Difference: ${diff})`;
      updateScore(diff);

      saveProgress(diff);

    } catch (e) {
      resultDiv.textContent = "Invalid expression.";
    }
  }

  function updateScore(score) {
    if (score === "") {
      scoreDiv.textContent = "";
      return;
    }
    scoreDiv.textContent = `Score (difference from target): ${score}`;
  }

  function saveProgress(newScore) {
    const todayKey = getTodayKey();
    const bestScoreKey = "dailyDiceBestScore-" + todayKey;
    const storedBest = localStorage.getItem(bestScoreKey);

    let bestScore = storedBest !== null ? Number(storedBest) : Infinity;
    if (newScore < bestScore) {
      localStorage.setItem(bestScoreKey, newScore);
      updateStreak(newScore);
      addToArchive(todayKey, newScore);
    } else {
      updateStreak();
    }
    updateArchive();
  }

  function getTodayKey() {
    const estMidnight = getEasternMidnight();
    return estMidnight.toISOString().slice(0, 10);
  }

  function updateStreak(newScore) {
    let streak = Number(localStorage.getItem("dailyDiceStreak")) || 0;
    const todayKey = getTodayKey();
    const yesterdayKey = getYesterdayKey();
    const storedBestYesterday = localStorage.getItem("dailyDiceBestScore-" + yesterdayKey);

    if (storedBestYesterday !== null) {
      if (newScore !== undefined && newScore <= Number(storedBestYesterday)) {
        streak += 1;
      } else if (newScore !== undefined) {
        streak = 1;
      }
    } else {
      if (newScore !== undefined) streak = 1;
    }

    localStorage.setItem("dailyDiceStreak", streak);
    streakDiv.textContent = `Current Streak: ${streak}`;
  }

  function getYesterdayKey() {
    const estMidnight = getEasternMidnight();
    estMidnight.setDate(estMidnight.getDate() - 1);
    return estMidnight.toISOString().slice(0, 10);
  }

  function addToArchive(date, score) {
    let archive = JSON.parse(localStorage.getItem("dailyDiceArchive") || "[]");
    const found = archive.find((entry) => entry.date === date);
    if (!found) {
      archive.push({ date, score });
      archive.sort((a,b) => b.date.localeCompare(a.date));
      if (archive.length > 30) archive.pop();
      localStorage.setItem("dailyDiceArchive", JSON.stringify(archive));
    } else if (score < found.score) {
      found.score = score;
      localStorage.setItem("dailyDiceArchive", JSON.stringify(archive));
    }
  }

  function updateArchive() {
    const archive = JSON.parse(localStorage.getItem("dailyDiceArchive") || "[]");
    if (archive.length === 0) {
      archiveDiv.textContent = "No archive data yet.";
      return;
    }
    archiveDiv.innerHTML = "<b>Archive (last 30 days):</b><br>" + 
      archive.map(e => `${e.date}: Best Score = ${e.score}`).join("<br>");
  }

  function loadProgress() {
    const todayKey = getTodayKey();
    const bestScore = localStorage.getItem("dailyDiceBestScore-" + todayKey);
    if (bestScore !== null) {
      scoreDiv.textContent = `Best score today: ${bestScore}`;
    } else {
      scoreDiv.textContent = "";
    }
    streakDiv.textContent = `Current Streak: ${localStorage.getItem("dailyDiceStreak") || 0}`;
  }

  window.onload = initGame;
</script>
</body>
</html>
